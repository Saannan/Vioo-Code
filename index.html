<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vioo-Code | Home</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="/" class="logo">Vioo-Code</a>
            <ul>
                <li class="when-signed-out"><a href="/sign-in.html">Sign In</a></li>
                <li class="when-signed-out"><a href="/sign-up.html" class="btn">Sign Up</a></li>
                <li class="when-signed-in"><a href="/new-paste.html" class="btn">New Paste</a></li>
                <li class="when-signed-in">
                    <a href="#" id="user-profile-link">
                        <img src="" alt="User Avatar" class="user-avatar" id="user-avatar-nav">
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <h1>Latest Public Pastes</h1>
            <div id="paste-list"></div>
        </div>
    </main>

    <script type="module">
        import { setupUI } from '/config/auth.js';
        import { getLatestPublicPastes } from '/config/api.js';

        const pasteListContainer = document.getElementById('paste-list');

        const renderPaste = (paste) => {
            const pasteEl = document.createElement('div');
            pasteEl.className = 'paste-list-item';
            pasteEl.innerHTML = `
                <h3><a href="/view-paste.html?id=${paste.id}">${paste.title}</a></h3>
                <div class="meta">
                    <img src="${paste.author_avatar_url}" alt="${paste.author_username}">
                    <span><a href="/profile.html?user=${paste.author_username}">${paste.author_username}</a></span>
                    <span>Language: ${paste.language}</span>
                    <span>${new Date(paste.created_at).toLocaleString()}</span>
                </div>
            `;
            pasteListContainer.appendChild(pasteEl);
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: user } = await supabase.auth.getUser();
            setupUI(user);

            const { data: pastes, error } = await getLatestPublicPastes();
            if (error) {
                pasteListContainer.innerHTML = `<p class="error-message">Could not fetch pastes.</p>`;
            } else if (pastes.length === 0) {
                 pasteListContainer.innerHTML = `<p>No public pastes yet. Be the first to create one!</p>`;
            }
            else {
                pastes.forEach(renderPaste);
            }
        });
    </script>
</body>
</html>