<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Paste - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
</head>
<body>
    <header id="main-header">
        <nav class="container">
            <div class="logo"><a href="/">Vioo<span>Code</span></a></div>
            <div class="nav-links">
                <a href="/new-paste.html" class="btn btn-primary when-signed-in hidden">New Paste</a>
            </div>
            <div class="nav-actions">
                <div class="when-signed-out hidden">
                    <a href="/sign-in.html" class="btn btn-secondary">Sign In</a>
                    <a href="/sign-up.html" class="btn btn-primary">Sign Up</a>
                </div>
                <div class="when-signed-in hidden">
                    <a href="#" class="nav-profile-link">
                        <img src="" alt="User Avatar" class="nav-user-avatar">
                    </a>
                </div>
                <button class="hamburger" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
    </header>

    <main class="container">
        <div id="loader">Loading paste...</div>
        <div id="paste-view" class="hidden">
            <div class="view-paste-layout">
                <aside class="paste-info-panel">
                    <h1 id="paste-title"></h1>
                    <div class="info-author">
                        <img id="author-avatar" src="" alt="Author Avatar">
                        <div>
                            <a id="author-username" class="username" href="#"></a>
                            <div id="paste-timestamp" class="timestamp"></div>
                        </div>
                    </div>
                    <p id="paste-description" style="color: var(--text-light); margin: 1rem 0;"></p>
                    <div class="paste-actions">
                         <a href="#" id="copy-btn-header" class="btn btn-secondary">Copy Code</a>
                         <a href="#" id="raw-link" target="_blank" class="btn btn-secondary">Raw</a>
                         <button id="delete-btn" class="btn hidden" style="background-color: #450A0A; color: #F87171; border-color: #7F1D1D;">Delete</button>
                    </div>
                </aside>

                <section class="paste-code-container">
                    <pre><code id="code-block"></code></pre>
                    <div class="comments-section">
                        <h2>Comments</h2>
                        <div class="when-signed-in hidden">
                            <form id="comment-form">
                                <div class="form-group">
                                    <textarea id="comment-text" placeholder="Add a public comment..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary" style="float: right;">Post</button>
                            </form>
                        </div>
                         <div class="when-signed-out hidden" style="padding: 1rem 0;">
                            <p>Please <a href="/sign-in.html" style="color: var(--primary-accent)">sign in</a> to post a comment.</p>
                        </div>
                        <div id="comment-list" class="comment-list"></div>
                    </div>
                </section>
            </div>
        </div>
        <div id="not-found"><h1>404 - Paste Not Found</h1><p>This paste may be private, unlisted, or does not exist.</p></div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script type="module">
        import { getPasteById, getRawPasteContent, deletePaste, addComment, listenForComments } from './config/api.js';
        import { onAuthReady } from './config/auth.js';
        import { supabase } from './config/firebase-init.js';
        import { supabaseConfig } from './config/config.js';

        const header = document.getElementById('main-header');
        const hamburger = document.querySelector('.hamburger');
        hamburger.addEventListener('click', () => header.classList.toggle('nav-open'));

        const loader = document.getElementById('loader');
        const pasteView = document.getElementById('paste-view');
        const notFoundDiv = document.getElementById('not-found');

        const escapeHTML = str => str ? str.replace(/[&<>"']/g, tag => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[tag] || tag)) : '';

        const params = new URLSearchParams(window.location.search);
        const pasteId = params.get('id');

        if (!pasteId) {
            loader.style.display = 'none';
            notFoundDiv.style.display = 'block';
        } else {
            onAuthReady().then(async (currentUser) => {
                try {
                    const paste = await getPasteById(pasteId);
                    if (!paste || (paste.visibility === 'private' && paste.authorUid !== currentUser?.uid)) {
                        throw new Error("Paste not found or private");
                    }
                    
                    document.title = `${paste.title} - Vioo-Code`;
                    document.getElementById('paste-title').textContent = paste.title;
                    document.getElementById('paste-description').textContent = paste.description || '';
                    document.getElementById('author-avatar').src = paste.authorAvatarUrl;
                    document.getElementById('author-username').textContent = paste.authorUsername;
                    document.getElementById('author-username').href = `/profile.html?username=${paste.authorUsername}`;
                    document.getElementById('paste-timestamp').textContent = `Created on ${new Date(paste.createdAt.seconds * 1000).toLocaleDateString()}`;
                    
                    const { data: { publicUrl } } = supabase.storage.from(supabaseConfig.bucket).getPublicUrl(paste.storagePath);
                    document.getElementById('raw-link').href = publicUrl;

                    const codeContent = await getRawPasteContent(paste.storagePath);
                    const codeBlock = document.getElementById('code-block');
                    codeBlock.className = `language-${paste.language}`;
                    codeBlock.textContent = codeContent;
                    Prism.highlightAll();

                    const copyToClipboard = () => navigator.clipboard.writeText(codeContent).then(() => alert('Copied to clipboard!'));
                    document.getElementById('copy-btn-header').addEventListener('click', copyToClipboard);

                    const deleteBtn = document.getElementById('delete-btn');
                    if (currentUser && currentUser.uid === paste.authorUid) {
                        deleteBtn.classList.remove('hidden');
                        deleteBtn.addEventListener('click', async () => {
                            if (confirm('Are you sure you want to permanently delete this paste?')) {
                                await deletePaste(pasteId, paste.storagePath);
                                window.location.href = `/profile.html?username=${currentUser.username}`;
                            }
                        });
                    }
                    
                    listenForComments(pasteId, (comments) => {
                        const list = document.getElementById('comment-list');
                        list.innerHTML = '';
                        comments.forEach(c => {
                            const item = document.createElement('div');
                            item.className = 'comment';
                            item.innerHTML = `<img src="${c.authorAvatarUrl}" alt="${c.authorUsername}"><div class="comment-body"><a href="/profile.html?username=${c.authorUsername}" class="comment-author">${c.authorUsername}</a><div class="comment-text">${escapeHTML(c.text)}</div></div>`;
                            list.appendChild(item);
                        });
                    });
                    
                    const commentForm = document.getElementById('comment-form');
                    commentForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const text = commentForm.querySelector('textarea').value.trim();
                        if (text && currentUser) {
                            await addComment(pasteId, text, currentUser);
                            commentForm.reset();
                        }
                    });

                    loader.style.display = 'none';
                    pasteView.classList.remove('hidden');
                } catch (error) {
                    loader.style.display = 'none';
                    notFoundDiv.style.display = 'block';
                }
            });
        }
    </script>
</body>
</html>