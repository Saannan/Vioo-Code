<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vioo-Code | View Paste</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="/" class="logo">Vioo-Code</a>
            <ul>
                <li class="when-signed-out"><a href="/sign-in.html">Sign In</a></li>
                <li class="when-signed-out"><a href="/sign-up.html" class="btn">Sign Up</a></li>
                <li class="when-signed-in"><a href="/new-paste.html" class="btn">New Paste</a></li>
                <li class="when-signed-in">
                    <a href="#" id="user-profile-link">
                        <img src="" alt="User Avatar" class="user-avatar" id="user-avatar-nav">
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container" id="paste-container">
            <div id="loader">Loading paste...</div>
        </div>

        <div class="container comments-section">
            <h2>Comments</h2>
            <div id="comments-list"></div>
            <form id="comment-form" class="when-signed-in">
                <div class="form-group">
                    <textarea id="comment-text" placeholder="Add a comment..." required></textarea>
                </div>
                <button type="submit" class="btn">Post Comment</button>
            </form>
            <div class="when-signed-out">
                <p><a href="/sign-in.html">Sign in</a> to post a comment.</p>
            </div>
        </div>
    </main>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script type="module">
        import { setupUI, getCurrentUser } from '/config/auth.js';
        import { getPasteById, getCommentsByPasteId, createComment, subscribeToComments } from '/config/api.js';

        const pasteContainer = document.getElementById('paste-container');
        const commentsList = document.getElementById('comments-list');
        const commentForm = document.getElementById('comment-form');
        const commentText = document.getElementById('comment-text');

        const params = new URLSearchParams(window.location.search);
        const pasteId = params.get('id');

        const renderComment = (comment) => {
            const el = document.createElement('div');
            el.className = 'comment';
            el.innerHTML = `
                <div class="comment-header">
                    <img src="${comment.author_avatar_url}" alt="${comment.author_username}">
                    <span class="username"><a href="/profile.html?user=${comment.author_username}">${comment.author_username}</a></span>
                    <span class="timestamp">${new Date(comment.created_at).toLocaleString()}</span>
                </div>
                <p>${comment.text.replace(/\n/g, '<br>')}</p>
            `;
            commentsList.appendChild(el);
        };

        document.addEventListener('DOMContentLoaded', async () => {
            if (!pasteId) {
                pasteContainer.innerHTML = `<p class="error-message">No paste ID provided.</p>`;
                return;
            }

            const user = await getCurrentUser();
            setupUI(user);

            const { data: paste, error } = await getPasteById(pasteId);

            if (error || !paste) {
                pasteContainer.innerHTML = `<p class="error-message">Could not load paste. It might be private or does not exist.</p>`;
                return;
            }

            document.title = `Vioo-Code | ${paste.title}`;
            pasteContainer.innerHTML = `
                <div class="view-paste-header">
                    <h1>${paste.title}</h1>
                    <p>${paste.description || ''}</p>
                    <div class="meta">
                        <img src="${paste.author_avatar_url}" alt="${paste.author_username}">
                        <div>
                            By <a href="/profile.html?user=${paste.author_username}">${paste.author_username}</a><br>
                            <small>${new Date(paste.created_at).toLocaleString()}</small>
                        </div>
                    </div>
                    <div class="paste-actions">
                        <button id="copy-btn" class="btn btn-secondary">Copy Code</button>
                        <a href="${supabase.storage.from('vioo-code').getPublicUrl(paste.storage_path).data.publicUrl}" target="_blank" class="btn btn-secondary">Raw</a>
                    </div>
                </div>
                <pre><code class="language-${paste.language}" id="code-block">${paste.content}</code></pre>
            `;
            Prism.highlightAll();

            const copyBtn = document.getElementById('copy-btn');
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(paste.content);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = 'Copy Code'; }, 2000);
            });

            const { data: comments } = await getCommentsByPasteId(pasteId);
            if (comments) {
                comments.forEach(renderComment);
            }

            subscribeToComments(pasteId, (newComment) => {
                renderComment(newComment);
            });
        });

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = commentText.value.trim();
            if (!text) return;
            
            const { error } = await createComment(pasteId, text);
            if (error) {
                alert('Error posting comment: ' + error.message);
            } else {
                commentText.value = '';
            }
        });
    </script>
</body>
</html>