<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Paste - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <nav class="navbar">
        <div class="logo"><a href="/index.html">Vioo-Code</a></div>
        <div class="nav-links">
            <a href="/index.html">Explore</a>
            <a href="/profile.html" class="when-signed-in" id="profile-link">
                <span id="user-profile-nav">Profile</span>
            </a>
        </div>
        <div class="auth-links">
            <a href="/sign-in.html" class="when-signed-out">Sign In</a>
            <a href="/sign-up.html" class="when-signed-out btn-like">Sign Up</a>
        </div>
    </nav>

    <main class="container" id="main-content">
        <div id="loader">Loading paste...</div>
    </main>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script type="module">
        import { getCurrentUser } from './config/auth.js';
        import { getPasteById, getRawPasteContent, getComments, postComment, subscribeToComments } from './config/api.js';

        const mainContent = document.getElementById('main-content');
        const params = new URLSearchParams(window.location.search);
        const pasteId = params.get('id');

        let currentPaste = null;
        let currentUser = null;

        function renderComment(comment) {
            const commentList = document.getElementById('comment-list');
            if (!commentList) return;

            const commentEl = document.createElement('div');
            commentEl.className = 'comment';
            const commentDate = new Date(comment.created_at).toLocaleString();

            commentEl.innerHTML = `
                <img src="${comment.author_avatar_url}" alt="${comment.author_username}" class="comment-avatar">
                <div class="comment-body">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author_username}</span>
                        <span class="comment-date">${commentDate}</span>
                    </div>
                    <p class="comment-text"></p>
                </div>
            `;
            commentEl.querySelector('.comment-text').textContent = comment.text;
            commentList.appendChild(commentEl);
        }

        async function loadComments() {
            const comments = await getComments(pasteId);
            const commentList = document.getElementById('comment-list');
            if(commentList) {
                commentList.innerHTML = '';
                comments.forEach(renderComment);
            }
        }

        async function handleCommentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const text = form.commentText.value;
            if (!text.trim()) return;

            const { data: { user } } = await getCurrentUser();
            if (!user) {
                alert('You must be logged in to comment.');
                return;
            }

            try {
                await postComment({ pasteId, text, user });
                form.reset();
            } catch (error) {
                alert(`Error posting comment: ${error.message}`);
            }
        }

        async function loadPaste() {
            if (!pasteId) {
                mainContent.innerHTML = '<h1>Paste not found</h1><p>No paste ID provided in the URL.</p>';
                return;
            }

            try {
                const { data } = await getCurrentUser();
                currentUser = data.user;
                
                const paste = await getPasteById(pasteId);
                currentPaste = paste;
                const content = await getRawPasteContent(paste.storage_path);
                const formattedDate = new Date(paste.created_at).toLocaleString();
                
                mainContent.innerHTML = `
                    <div class="view-paste-container">
                        <div class="view-paste-header">
                            <h1 class="view-paste-title">${paste.title}</h1>
                            <div class="view-paste-meta">
                                <img src="${paste.author_avatar_url}" alt="${paste.author_username}" style="width:24px; height:24px; border-radius:50%;">
                                <a href="/profile.html?user=${paste.author_username}">${paste.author_username}</a>
                                <span>•</span>
                                <span>${formattedDate}</span>
                                <span>•</span>
                                <span class="paste-card-lang" style="font-size: 0.9rem;">${paste.language}</span>
                            </div>
                        </div>
                        <div class="view-paste-actions">
                            <button id="copy-btn" class="action-btn">Copy</button>
                            <a href="#" id="raw-link" class="action-btn" target="_blank">Raw</a>
                        </div>
                        <div class="code-wrapper">
                            <pre><code class="language-${paste.language}" id="code-content"></code></pre>
                        </div>
                    </div>
                    <div class="comments-section">
                        <h2>Comments</h2>
                        <div class="when-signed-in" style="display: none;">
                            <form id="comment-form" class="comment-form">
                                <div class="form-group">
                                    <textarea name="commentText" placeholder="Write a comment..." required></textarea>
                                </div>
                                <button type="submit" class="btn" style="width: auto; padding: 0.6rem 1.2rem;">Post Comment</button>
                            </form>
                        </div>
                         <div class="when-signed-out" style="display: block;">
                            <p><a href="/sign-in.html">Sign in</a> to post a comment.</p>
                        </div>
                        <div id="comment-list" class="comment-list"></div>
                    </div>
                `;
                
                document.getElementById('code-content').textContent = content;

                document.getElementById('copy-btn').addEventListener('click', () => {
                    navigator.clipboard.writeText(content);
                    const btn = document.getElementById('copy-btn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
                });

                const rawLink = document.getElementById('raw-link');
                rawLink.href = `https://fllyfxfiwajcmkqpvabz.supabase.co/storage/v1/object/public/${paste.storage_path}`;

                if (currentUser) {
                    document.querySelectorAll('.when-signed-in').forEach(el => el.style.display = 'block');
                    document.querySelectorAll('.when-signed-out').forEach(el => el.style.display = 'none');
                }

                document.getElementById('comment-form')?.addEventListener('submit', handleCommentSubmit);
                
                Prism.highlightAll();
                await loadComments();
                subscribeToComments(pasteId, (newComment) => {
                    renderComment(newComment);
                });

            } catch (error) {
                console.error('Error loading paste:', error);
                mainContent.innerHTML = `<h1>Error</h1><p>${error.message}</p>`;
            }
        }

        loadPaste();
    </script>
</body>
</html>