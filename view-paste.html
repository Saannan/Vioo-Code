<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Paste - Vioo-Code</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" integrity="sha512-vswe+cgvic/XBoF1OcM/TeJ2UJCowEBfednYmsbMmJrVflwlUBcG9YdFycENhPppBGYL+utxClMgWxVpO6cNJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div id="loader" class="loading-spinner"></div>
    
    <header>
        <a href="/" class="logo">Vioo<span>-Code</span></a>
        <nav>
            <ul>
                <li class="when-signed-out" style="display: none;"><a href="/sign-in.html" class="btn btn-primary">Sign In</a></li>
                <li class="when-signed-out" style="display: none;"><a href="/sign-up.html">Sign Up</a></li>
                <li class="when-signed-in user-details" style="display: none;">
                    <a href="/profile.html" class="user-menu">
                        <img src="" alt="User Avatar" class="user-avatar">
                        <span class="user-username"></span>
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="view-paste-container">
        <div id="paste-content" class="hidden">
            <div class="paste-header">
                <h1 id="paste-title"></h1>
                <div class="paste-meta-info">
                    <div id="paste-author" class="paste-author-info"></div>
                    <span id="paste-date"></span>
                    <span id="paste-visibility"></span>
                    <span id="paste-language"></span>
                </div>
                <div class="paste-actions">
                    <button id="copy-btn" class="btn btn-primary">Copy Code</button>
                    <a id="raw-btn" href="#" target="_blank" class="btn btn-primary">Raw</a>
                </div>
            </div>

            <pre><code id="code-block"></code></pre>
            
            <section class="comments-section">
                <h2>Comments</h2>
                <div id="comments-list"></div>
                <form id="comment-form" class="when-signed-in" style="display: none;">
                    <textarea id="comment-text" class="form-control" placeholder="Write a comment..." required></textarea>
                    <button type="submit" class="btn btn-primary">Post</button>
                </form>
                <p class="when-signed-out" style="display: none;">
                    <a href="/sign-in.html">Sign in</a> to post a comment.
                </p>
            </section>
        </div>
        <div id="error-message" class="hidden"></div>
    </main>
    
    <div id="popup-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="popup-title"></h2>
                <button id="popup-close" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="popup-message"></p>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7Gbl2MAQU5czDPVBgVZNrlCRp6RTSoY3v5G4A0s1T4Xb7YVpjP1Aw1/aKmLQpfA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-fC0IpaIWnKOgWn3LOdkIeBpaPOMU7_w2x+QO5gMjM2zIFlM1V9UNoT8Jt22TfU+aQ4onpSA2iTBgvyFbdFk0hw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="/js/ui.js"></script>
    <script type="module">
        import { requireAuth, getCurrentUser } from './config/auth.js';
        import { getPaste, getRawContent, postComment, listenForComments } from './config/api.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await requireAuth();
            const loader = document.getElementById('loader');
            const contentDiv = document.getElementById('paste-content');
            const errorDiv = document.getElementById('error-message');
            
            const params = new URLSearchParams(window.location.search);
            const pasteId = params.get('id');

            if (!pasteId) {
                errorDiv.innerHTML = '<h1>404 - Not Found</h1><p>No paste ID provided.</p>';
                errorDiv.classList.remove('hidden');
                loader.classList.add('hidden');
                return;
            }

            try {
                const paste = await getPaste(pasteId);

                if (!paste) {
                    throw new Error("Paste not found.");
                }

                if (paste.visibility === 'private' && (!user || user.uid !== paste.authorUid)) {
                    throw new Error("This is a private paste and you do not have permission to view it.");
                }

                document.title = `${paste.title} - Vioo-Code`;
                document.getElementById('paste-title').textContent = paste.title;
                document.getElementById('paste-date').textContent = `Created on ${new Date(paste.createdAt).toLocaleString()}`;
                document.getElementById('paste-author').innerHTML = `<img src="${paste.authorAvatarUrl}" alt="${paste.authorUsername}"> <a href="/profile.html?user=${paste.authorUsername}">${paste.authorUsername}</a>`;
                document.getElementById('paste-visibility').textContent = `Visiblity: ${paste.visibility}`;
                document.getElementById('paste-language').textContent = `Language: ${paste.language}`;
                document.getElementById('raw-btn').href = paste.storagePath;

                const rawContent = await getRawContent(paste.storagePath);
                const codeBlock = document.getElementById('code-block');
                codeBlock.className = `language-${paste.language}`;
                codeBlock.textContent = rawContent;
                Prism.highlightElement(codeBlock);
                
                document.getElementById('copy-btn').addEventListener('click', () => {
                    navigator.clipboard.writeText(rawContent).then(() => {
                        showPopup('Success', 'Code copied to clipboard!');
                    });
                });

                const commentForm = document.getElementById('comment-form');
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const commentText = document.getElementById('comment-text');
                    if (commentText.value.trim()) {
                        try {
                            await postComment(pasteId, commentText.value);
                            commentText.value = '';
                        } catch (error) {
                            showPopup('Error', 'Failed to post comment.');
                        }
                    }
                });

                const commentsList = document.getElementById('comments-list');
                listenForComments(pasteId, (snapshot) => {
                    commentsList.innerHTML = '';
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const comment = child.val();
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment';
                            commentEl.innerHTML = `
                                <div class="comment-avatar">
                                    <img src="${comment.authorAvatarUrl}" alt="${comment.authorUsername}">
                                </div>
                                <div class="comment-content">
                                    <div>
                                        <span class="author">${comment.authorUsername}</span>
                                        <span class="timestamp">${new Date(comment.timestamp).toLocaleString()}</span>
                                    </div>
                                    <p class="text">${comment.text}</p>
                                </div>
                            `;
                            commentsList.prepend(commentEl);
                        });
                    } else {
                        commentsList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
                    }
                });

                contentDiv.classList.remove('hidden');

            } catch (error) {
                errorDiv.innerHTML = `<h1>Error</h1><p>${error.message}</p>`;
                errorDiv.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        });
    </script>
</body>
</html>