<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Paste - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo"><a href="/">Vioo<span>-Code</span></a></div>
            <div class="nav-auth">
                <div class="when-signed-out">
                    <a href="/sign-in.html" class="btn btn-secondary">Sign In</a>
                    <a href="/sign-up.html" class="btn btn-primary">Sign Up</a>
                </div>
                <div class="when-signed-in">
                    <a href="/new-paste.html" class="btn btn-primary">New Paste</a>
                    <a href="#" id="nav-profile-link">
                        <img src="" alt="User Avatar" id="nav-user-avatar">
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container">
        <div id="loader">Loading paste...</div>
        
        <div id="paste-view" style="display: none;">
            <div class="view-paste-layout">
                <aside class="paste-info-panel">
                    <h1 id="paste-title"></h1>
                    <p id="paste-description"></p>
                    <div class="info-author">
                        <img id="author-avatar" src="" alt="Author Avatar">
                        <div>
                            <a id="author-username" class="username" href="#"></a>
                            <div id="paste-timestamp" class="timestamp"></div>
                        </div>
                    </div>
                    <div class="paste-meta-grid">
                        <div class="meta-item">
                            <div class="label">Language</div>
                            <div id="meta-language" class="value"></div>
                        </div>
                        <div class="meta-item">
                            <div class="label">Visibility</div>
                            <div id="meta-visibility" class="value"></div>
                        </div>
                    </div>
                    <div class="paste-actions">
                         <a href="#" id="copy-btn-header" class="btn btn-secondary">Copy Code</a>
                         <a href="#" id="raw-link" target="_blank" class="btn btn-secondary">Raw</a>
                         <button id="delete-btn" class="btn" style="background-color: var(--error); display: none;">Delete Paste</button>
                    </div>
                </aside>
                
                <section class="paste-code-container">
                    <div class="paste-code-panel">
                        <pre><code id="code-block"></code></pre>
                        <button class="btn copy-btn" id="copy-btn-pre">Copy</button>
                    </div>
                    
                    <div class="comments-section">
                        <h2>Comments</h2>
                        <div class="when-signed-in">
                            <form id="comment-form">
                                <div class="form-group">
                                    <textarea id="comment-text" placeholder="Add a public comment..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Post Comment</button>
                            </form>
                        </div>
                         <div class="when-signed-out" style="display:none">
                            <p>Please <a href="/sign-in.html" style="color: var(--primary-accent)">sign in</a> to post a comment.</p>
                        </div>
                        <div id="comment-list" class="comment-list"></div>
                    </div>
                </section>
            </div>
        </div>

        <div id="not-found">
            <h1>404 - Paste Not Found</h1>
            <p>This paste may be private, unlisted, or does not exist.</p>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script type="module">
        import { getPasteById, getRawPasteContent, deletePaste, addComment, listenForComments } from './config/api.js';
        import { getCurrentUser } from './config/auth.js';
        import { supabase } from './config/firebase-init.js';
        import { supabaseConfig } from './config/config.js';

        const loader = document.getElementById('loader');
        const pasteView = document.getElementById('paste-view');
        const notFoundDiv = document.getElementById('not-found');

        const escapeHTML = str => str ? str.replace(/[&<>"']/g, tag => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[tag] || tag)) : '';

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const pasteId = params.get('id');

            if (!pasteId) {
                loader.style.display = 'none';
                notFoundDiv.style.display = 'block';
                return;
            }

            try {
                const paste = await getPasteById(pasteId);
                const currentUser = getCurrentUser();

                if (!paste || (paste.visibility === 'private' && paste.authorUid !== currentUser?.uid)) {
                    loader.style.display = 'none';
                    notFoundDiv.style.display = 'block';
                    return;
                }

                document.title = `${paste.title} - Vioo-Code`;
                document.getElementById('paste-title').textContent = paste.title;
                document.getElementById('paste-description').textContent = paste.description || 'No description provided.';
                document.getElementById('author-avatar').src = paste.authorAvatarUrl;
                document.getElementById('author-username').textContent = paste.authorUsername;
                document.getElementById('author-username').href = `/profile.html?username=${paste.authorUsername}`;
                document.getElementById('paste-timestamp').textContent = `Created on ${new Date(paste.createdAt.seconds * 1000).toLocaleString()}`;
                document.getElementById('meta-language').textContent = paste.language;
                document.getElementById('meta-visibility').textContent = paste.visibility.charAt(0).toUpperCase() + paste.visibility.slice(1);
                
                const { data: { publicUrl } } = supabase.storage.from(supabaseConfig.bucket).getPublicUrl(paste.storagePath);
                document.getElementById('raw-link').href = publicUrl;

                const codeContent = await getRawPasteContent(paste.storagePath);
                const codeBlock = document.getElementById('code-block');
                codeBlock.className = `language-${paste.language}`;
                codeBlock.textContent = codeContent;
                Prism.highlightAll();

                const copyToClipboard = () => navigator.clipboard.writeText(codeContent).then(() => alert('Copied to clipboard!'));
                document.getElementById('copy-btn-header').addEventListener('click', copyToClipboard);
                document.getElementById('copy-btn-pre').addEventListener('click', copyToClipboard);

                const deleteBtn = document.getElementById('delete-btn');
                if (currentUser && currentUser.uid === paste.authorUid) {
                    deleteBtn.style.display = 'block';
                    deleteBtn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to permanently delete this paste?')) {
                            await deletePaste(pasteId, paste.storagePath);
                            window.location.href = `/profile.html?username=${currentUser.username}`;
                        }
                    });
                }
                
                listenForComments(pasteId, renderComments);
                setupCommentForm(pasteId);
                
                loader.style.display = 'none';
                pasteView.style.display = 'block';

            } catch (error) {
                console.error("Error loading paste:", error);
                loader.style.display = 'none';
                notFoundDiv.style.display = 'block';
            }
        });
        
        function setupCommentForm(pasteId) {
            const commentForm = document.getElementById('comment-form');
            commentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const commentText = document.getElementById('comment-text');
                const text = commentText.value.trim();
                const currentUser = getCurrentUser();
                
                if (text && currentUser) {
                    try {
                        await addComment(pasteId, text, currentUser);
                        commentText.value = '';
                    } catch (error) {
                        alert("Failed to post comment.");
                    }
                }
            });
        }

        function renderComments(comments) {
            const commentList = document.getElementById('comment-list');
            commentList.innerHTML = '';
            if (comments.length === 0) {
                return;
            }
            comments.forEach(comment => {
                const commentEl = document.createElement('div');
                commentEl.className = 'comment';
                commentEl.innerHTML = `
                    <img src="${comment.authorAvatarUrl}" alt="${comment.authorUsername}">
                    <div class="comment-body">
                       <div class="comment-header">
                            <a href="/profile.html?username=${comment.authorUsername}" class="comment-author">${comment.authorUsername}</a>
                            <span class="comment-timestamp">${new Date(comment.timestamp).toLocaleString()}</span>
                       </div>
                        <div class="comment-text">${escapeHTML(comment.text)}</div>
                    </div>
                `;
                commentList.appendChild(commentEl);
            });
        }
    </script>
</body>
</html>