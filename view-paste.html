<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Paste - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="logo">Vioo<span>-Code</span></a>
            <nav>
                <ul>
                    <li class="when-signed-in">
                        <a id="nav-dashboard-link" href="/profile.html">My Dashboard</a>
                    </li>
                    <li class="when-signed-in">
                        <a id="logout-button" href="#">Sign Out</a>
                    </li>
                    <li class="when-signed-out">
                        <a href="/sign-in.html" class="btn btn-primary">Sign In</a>
                    </li>
                    <li class="when-signed-out">
                        <a href="/sign-up.html" class="btn btn-secondary">Sign Up</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container" id="main-content">
        <div class="view-paste-container" id="paste-view">
        </div>
        <div class="empty-state" id="not-found" style="display: none;">
            <h2>Paste Not Found</h2>
            <p>The paste you are looking for does not exist or you do not have permission to view it.</p>
        </div>
    </main>
    
    <a href="/new-paste.html" id="fab-create-paste" class="fab when-signed-in">+</a>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

    <script type="module">
        import { handleSignOut, getCurrentUser } from './config/auth.js';
        import { getPasteById, addComment, listenForComments, deletePaste } from './config/api.js';
        import { ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { db } from './config/firebase-init.js';

        const mainContent = document.getElementById('main-content');
        const pasteView = document.getElementById('paste-view');
        const notFoundView = document.getElementById('not-found');

        const escapeHTML = (str) => str.replace(/[&<>"']/g, match => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[match]);

        const renderPaste = async (pasteId) => {
            const currentUser = await getCurrentUser();
            const pasteData = await getPasteById(pasteId);

            if (!pasteData) {
                pasteView.style.display = 'none';
                notFoundView.style.display = 'block';
                return;
            }

            const isOwner = currentUser && currentUser.uid === pasteData.authorUid;
            
            if (pasteData.visibility === 'private' && !isOwner) {
                pasteView.style.display = 'none';
                notFoundView.style.display = 'block';
                return;
            }

            let content = 'Loading content...';
            try {
                const response = await fetch(pasteData.storagePath);
                if (response.ok) {
                    content = await response.text();
                } else {
                    content = 'Error: Could not load paste content.';
                }
            } catch (error) {
                content = 'Error: Could not load paste content.';
            }

            document.title = `${escapeHTML(pasteData.title)} - Vioo-Code`;
            
            pasteView.innerHTML = `
                <div class="paste-header">
                    <h1 class="paste-title">${escapeHTML(pasteData.title)}</h1>
                    <div class="paste-meta-info">
                        <div class="author-info">
                            <img src="${pasteData.authorAvatarUrl}" alt="${escapeHTML(pasteData.authorUsername)}">
                            <a href="/profile.html?username=${escapeHTML(pasteData.authorUsername)}">${escapeHTML(pasteData.authorUsername)}</a>
                        </div>
                        <span>${new Date(pasteData.createdAt).toLocaleString()}</span>
                        <span>${pasteData.stats.views} views</span>
                        <span class="visibility-badge visibility-${pasteData.visibility}">${pasteData.visibility}</span>
                    </div>
                </div>
                <div class="paste-actions">
                    <button id="copy-btn" class="btn btn-secondary">Copy</button>
                    <a href="${pasteData.storagePath}" target="_blank" class="btn btn-secondary">Raw</a>
                    ${isOwner ? `
                        <a href="/new-paste.html?edit=${pasteId}" class="btn btn-secondary">Edit</a>
                        <button id="delete-btn" class="btn btn-secondary">Delete</button>
                    ` : ''}
                </div>
                <div class="code-container">
                    <pre><code class="language-${escapeHTML(pasteData.language)}">${escapeHTML(content)}</code></pre>
                </div>
                <div class="comments-section">
                    <h2>Comments (${pasteData.stats.comments})</h2>
                    <div id="comments-list"></div>
                    <form id="comment-form" class="when-signed-in">
                        <div class="form-group">
                            <textarea id="comment-text" placeholder="Add a comment..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Post Comment</button>
                    </form>
                    <p class="when-signed-out">You must be <a href="/sign-in.html">signed in</a> to comment.</p>
                </div>
            `;
            
            Prism.highlightAll();

            document.getElementById('copy-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(content).then(() => {
                    alert('Copied to clipboard!');
                });
            });

            if (isOwner) {
                document.getElementById('delete-btn').addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this paste? This action cannot be undone.')) {
                        try {
                            await deletePaste(pasteId, currentUser.uid);
                            alert('Paste deleted successfully.');
                            window.location.href = '/';
                        } catch(e) {
                            alert('Error deleting paste: ' + e.message);
                        }
                    }
                });
            }

            if (currentUser) {
                const commentForm = document.getElementById('comment-form');
                commentForm.addEventListener('submit', handleCommentSubmit);
            }

            listenForComments(pasteId, renderComments);
        };
        
        const renderComments = (comments) => {
            const commentsList = document.getElementById('comments-list');
            if (!commentsList) return;
            if (comments.length === 0) {
                commentsList.innerHTML = '<p>No comments yet.</p>';
                return;
            }
            commentsList.innerHTML = comments.map(comment => `
                <div class="comment">
                    <div class="comment-author">
                        <img src="${comment.authorAvatarUrl}" alt="${escapeHTML(comment.authorUsername)}">
                        <span>${escapeHTML(comment.authorUsername)}</span>
                        <span class="comment-timestamp">${new Date(comment.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="comment-text">
                        <p>${escapeHTML(comment.text)}</p>
                    </div>
                </div>
            `).join('');
        };
        
        const handleCommentSubmit = async (e) => {
            e.preventDefault();
            const currentUser = await getCurrentUser();
            const params = new URLSearchParams(window.location.search);
            const pasteId = params.get('id');
            const commentText = document.getElementById('comment-text');

            if (!currentUser || !pasteId || !commentText.value.trim()) return;

            const userProfileRef = ref(db, `users/${currentUser.uid}`);
            const snapshot = await get(userProfileRef);
            if (!snapshot.exists()) {
                alert('Could not find your user profile.');
                return;
            }
            const userData = snapshot.val();
            
            const commentData = {
                text: commentText.value.trim(),
                authorUid: currentUser.uid,
                authorUsername: userData.username,
                authorAvatarUrl: userData.avatarUrl
            };
            
            try {
                await addComment(pasteId, commentData);
                commentText.value = '';
            } catch (error) {
                alert('Failed to post comment: ' + error.message);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const logoutButton = document.getElementById('logout-button');
            if(logoutButton) logoutButton.addEventListener('click', e => { e.preventDefault(); handleSignOut(); });

            const params = new URLSearchParams(window.location.search);
            const pasteId = params.get('id');
            
            if (pasteId) {
                renderPaste(pasteId);
            } else {
                pasteView.style.display = 'none';
                notFoundView.style.display = 'block';
            }
        });

    </script>
</body>
</html>