<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Paste - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo"><a href="/">Vioo<span>-Code</span></a></div>
            <div class="nav-links">
                <a href="/new-paste.html" class="when-signed-in">New Paste</a>
            </div>
            <div class="nav-auth">
                <div class="when-signed-out">
                    <a href="/sign-in.html">Sign In</a>
                    <a href="/sign-up.html" class="btn btn-primary">Sign Up</a>
                </div>
                <div class="when-signed-in nav-user-profile">
                    <a href="#" id="nav-profile-link"></a>
                    <img src="" alt="User Avatar" id="nav-user-avatar">
                    <a href="#" id="sign-out-btn">Logout</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container">
        <div id="loader">Loading paste...</div>
        <div id="paste-container" style="display: none;">
            <div class="view-paste-container">
                <div class="paste-header">
                    <h1 id="paste-title"></h1>
                    <div class="paste-info">
                        <img id="author-avatar" src="" alt="Author Avatar">
                        <div class="author-details">
                            <a id="author-username" class="username" href="#"></a>
                            <span id="paste-timestamp" class="timestamp"></span>
                        </div>
                    </div>
                     <p id="paste-description" style="color: var(--text-medium); margin-bottom: 1rem;"></p>
                    <div class="paste-actions">
                        <a href="#" id="copy-btn-header" class="btn">Copy Code</a>
                        <a href="#" id="raw-link" target="_blank" class="btn">Raw</a>
                        <button id="delete-btn" class="btn" style="background-color: var(--error); display: none;">Delete</button>
                    </div>
                </div>
                <div class="paste-content">
                    <pre><code id="code-block"></code></pre>
                    <button class="btn copy-btn" id="copy-btn-pre">Copy</button>
                </div>
            </div>

            <div class="comments-section">
                <h2>Comments</h2>
                <div class="when-signed-in">
                    <form id="comment-form">
                        <div class="form-group">
                            <textarea id="comment-text" placeholder="Add a comment..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Post Comment</button>
                    </form>
                </div>
                 <div class="when-signed-out">
                    <p><a href="/sign-in.html">Sign in</a> to post a comment.</p>
                </div>
                <div id="comment-list" class="comment-list"></div>
            </div>
        </div>
        <div id="not-found" style="display: none; text-align: center;">
            <h1>404 - Paste Not Found</h1>
            <p>This paste may be private, unlisted, or does not exist.</p>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Vioo-Code. All Rights Reserved.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script type="module">
        import { getPasteById, getRawPasteContent, deletePaste, addComment, listenForComments } from './config/api.js';
        import { signOut, getCurrentUser } from './config/auth.js';
        import { supabase } from './config/firebase-init.js';
        import { supabaseConfig } from './config/config.js';

        const loader = document.getElementById('loader');
        const pasteContainer = document.getElementById('paste-container');
        const notFoundDiv = document.getElementById('not-found');
        let currentPasteData = null;

        const escapeHTML = str => str.replace(/[&<>"']/g, 
            tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[tag]));

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const pasteId = params.get('id');

            if (!pasteId) {
                loader.style.display = 'none';
                notFoundDiv.style.display = 'block';
                return;
            }

            try {
                const paste = await getPasteById(pasteId);
                currentPasteData = paste;
                const currentUser = getCurrentUser();

                if (!paste || (paste.visibility === 'private' && paste.authorUid !== currentUser?.uid)) {
                    loader.style.display = 'none';
                    notFoundDiv.style.display = 'block';
                    return;
                }

                document.title = `${paste.title} - Vioo-Code`;
                document.getElementById('paste-title').textContent = paste.title;
                document.getElementById('paste-description').textContent = paste.description || '';
                document.getElementById('author-avatar').src = paste.authorAvatarUrl;
                document.getElementById('author-username').textContent = paste.authorUsername;
                document.getElementById('author-username').href = `/profile.html?username=${paste.authorUsername}`;
                document.getElementById('paste-timestamp').textContent = `Created on ${new Date(paste.createdAt.seconds * 1000).toLocaleString()}`;
                
                const rawLink = document.getElementById('raw-link');
                const { data: { publicUrl } } = supabase.storage.from(supabaseConfig.bucket).getPublicUrl(paste.storagePath);
                rawLink.href = publicUrl;

                const codeContent = await getRawPasteContent(paste.storagePath);
                const codeBlock = document.getElementById('code-block');
                codeBlock.className = `language-${paste.language}`;
                codeBlock.textContent = codeContent;
                Prism.highlightAll();

                const copyToClipboard = () => {
                    navigator.clipboard.writeText(codeContent).then(() => {
                        alert('Copied to clipboard!');
                    });
                };
                document.getElementById('copy-btn-header').addEventListener('click', copyToClipboard);
                document.getElementById('copy-btn-pre').addEventListener('click', copyToClipboard);

                const deleteBtn = document.getElementById('delete-btn');
                if (currentUser && currentUser.uid === paste.authorUid) {
                    deleteBtn.style.display = 'inline-block';
                    deleteBtn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this paste?')) {
                            await deletePaste(pasteId, paste.storagePath);
                            window.location.href = '/';
                        }
                    });
                }
                
                listenForComments(pasteId, renderComments);
                setupCommentForm(pasteId);
                
                loader.style.display = 'none';
                pasteContainer.style.display = 'block';

            } catch (error) {
                console.error("Error loading paste:", error);
                loader.style.display = 'none';
                notFoundDiv.style.display = 'block';
            }
        });
        
        function setupCommentForm(pasteId) {
            const commentForm = document.getElementById('comment-form');
            commentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const commentText = document.getElementById('comment-text');
                const text = commentText.value.trim();
                const currentUser = getCurrentUser();
                
                if (text && currentUser) {
                    try {
                        await addComment(pasteId, text, currentUser);
                        commentText.value = '';
                    } catch (error) {
                        console.error("Error adding comment: ", error);
                        alert("Failed to post comment.");
                    }
                }
            });
        }

        function renderComments(comments) {
            const commentList = document.getElementById('comment-list');
            commentList.innerHTML = '';
            if (comments.length === 0) {
                commentList.innerHTML = '<p>No comments yet.</p>';
                return;
            }
            comments.forEach(comment => {
                const commentEl = document.createElement('div');
                commentEl.className = 'comment';
                commentEl.innerHTML = `
                    <img src="${comment.authorAvatarUrl}" alt="${comment.authorUsername}">
                    <div class="comment-body">
                        <p>
                            <a href="/profile.html?username=${comment.authorUsername}" class="comment-author">${comment.authorUsername}</a>
                            <span class="comment-timestamp">${new Date(comment.timestamp).toLocaleString()}</span>
                        </p>
                        <p>${escapeHTML(comment.text)}</p>
                    </div>
                `;
                commentList.appendChild(commentEl);
            });
        }

        const signOutBtn = document.getElementById('sign-out-btn');
        if (signOutBtn) {
            signOutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signOut();
            });
        }
    </script>
</body>
</html>