<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Paste - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css">
    <link rel="icon" href="https://api.dicebear.com/8.x/initials/svg?seed=VC&backgroundColor=0D1117,ffc300" type="image/svg+xml">
</head>
<body>
    <header class="header">
        <div class="container header-container">
            <a href="/" class="logo">Vioo<span>-Code</span></a>
            <nav>
                <ul class="nav-links" id="nav-menu">
                    <li><a href="/explore.html">Explore</a></li>
                    <li class="when-signed-in" style="display: none;"><a href="/profile.html" id="nav-profile-link-mobile">My Profile</a></li>
                    <li class="when-signed-in" style="display: none;"><button id="sign-out-btn-mobile" class="btn-logout">Logout</button></li>
                    <li class="when-signed-out" style="display: none;"><a href="/sign-in.html">Sign In</a></li>
                    <li class="when-signed-out" style="display: none;"><a href="/sign-up.html">Sign Up</a></li>
                </ul>
            </nav>
            <div class="nav-auth">
                <a href="/new-paste.html" class="btn btn-primary when-signed-in" style="display: none;">New Paste</a>
                <div class="user-menu when-signed-in" style="display: none;">
                    <a href="/profile.html" id="nav-profile-link"><img src="" alt="User Avatar" class="user-avatar"></a>
                </div>
                 <a href="/sign-in.html" class="btn btn-secondary when-signed-out">Sign In</a>
                 <a href="/sign-up.html" class="btn btn-primary when-signed-out">Sign Up</a>
                <button class="mobile-nav-toggle" id="mobile-nav-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container" id="paste-view-container">
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script type="module">
        import { getCurrentUser } from './config/auth.js';
        import { getPasteById, getRawPasteContent, postComment, listenForComments } from './config/api.js';
        import { supabaseConfig } from './config/config.js';

        const container = document.getElementById('paste-view-container');
        const urlParams = new URLSearchParams(window.location.search);
        const pasteId = urlParams.get('id');

        const mobileNavToggle = document.getElementById('mobile-nav-toggle');
        const navMenu = document.getElementById('nav-menu');
        mobileNavToggle.addEventListener('click', () => navMenu.classList.toggle('active'));
        
        async function renderPage() {
            if (!pasteId) {
                container.innerHTML = '<h1 class="page-heading">Paste Not Found</h1><p>The requested paste ID is missing.</p>';
                return;
            }

            try {
                const paste = await getPasteById(pasteId);
                const currentUser = await getCurrentUser();

                if (!paste) {
                    container.innerHTML = '<h1 class="page-heading">Paste Not Found</h1><p>This paste may have been deleted or the link is incorrect.</p>';
                    return;
                }
                
                const isOwner = currentUser && currentUser.uid === paste.authorUid;
                if(paste.visibility === 'private' && !isOwner) {
                     container.innerHTML = '<h1 class="page-heading">Access Denied</h1><p>This is a private paste.</p>';
                    return;
                }

                document.title = `${paste.title} - Vioo-Code`;
                const rawContent = await getRawPasteContent(paste.storagePath);
                
                container.innerHTML = `
                <div class="view-layout">
                    <div class="view-main">
                        <div class="paste-content-container">
                             <pre><code class="language-${paste.language}">${rawContent.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre>
                        </div>
                        <section class="comments-section">
                            <h2>Comments</h2>
                            <div class="when-signed-in" style="display: none;">
                                <form id="comment-form" class="form-box" style="padding: 0; background: none; border: none;">
                                    <div class="form-group">
                                        <textarea id="comment-text" class="form-textarea" placeholder="Add a public comment..." required style="min-height: 100px;"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Post Comment</button>
                                </form>
                            </div>
                             <div class="when-signed-out" style="display:none;"><p><a href="/sign-in.html">Sign in</a> to post a comment.</p></div>
                            <div id="comment-list"></div>
                        </section>
                    </div>
                    <aside class="view-sidebar">
                        <div class="info-box">
                            <h1>${paste.title}</h1>
                            <ul class="meta-list">
                                <li>
                                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                     <a href="/profile.html?username=${paste.authorUsername}"><strong>${paste.authorUsername}</strong></a>
                                </li>
                                <li>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9.75L16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z" /></svg>
                                    <span>${paste.language}</span>
                                </li>
                                 <li>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                    <span>${paste.visibility}</span>
                                </li>
                                <li>
                                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
                                    <span>${new Date(paste.createdAt?.toDate()).toLocaleDateString()}</span>
                                </li>
                            </ul>
                            <div class="actions">
                                <button id="copy-btn" class="btn btn-secondary">Copy</button>
                                <a href="${supabaseConfig.url}/storage/v1/object/public/${supabaseConfig.bucket}/${paste.storagePath}" target="_blank" class="btn btn-secondary">Raw</a>
                            </div>
                        </div>
                    </aside>
                </div>
                `;

                Prism.highlightAll();
                setupEventListeners(rawContent, currentUser);
                loadComments();

            } catch (error) {
                container.innerHTML = `<h1 class="page-heading">Error</h1><p>${error.message}</p>`;
            }
        }

        function setupEventListeners(content, user) {
            const copyBtn = document.getElementById('copy-btn');
            copyBtn.addEventListener('click', (e) => {
                navigator.clipboard.writeText(content).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
                });
            });

            const commentForm = document.getElementById('comment-form');
            if(commentForm) {
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const text = document.getElementById('comment-text').value;
                    if (!text.trim() || !user) return;
                    try {
                        await postComment(pasteId, text, user);
                        document.getElementById('comment-text').value = '';
                    } catch (err) { alert('Could not post comment.'); }
                });
            }
        }

        function loadComments() {
            const list = document.getElementById('comment-list');
            listenForComments(pasteId, (comments) => {
                if(comments.length === 0) {
                    list.innerHTML = '<p>No comments yet.</p>';
                    return;
                }
                list.innerHTML = comments.map(c => `
                    <div class="comment">
                        <div class="comment-header">
                            <img src="${c.authorAvatarUrl}" alt="${c.authorUsername}">
                            <a href="/profile.html?username=${c.authorUsername}"><strong>${c.authorUsername}</strong></a>
                            <span>${new Date(c.timestamp).toLocaleString()}</span>
                        </div>
                        <p>${c.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
                    </div>
                `).join('');
            });
        }
        
        renderPage();
    </script>
</body>
</html>