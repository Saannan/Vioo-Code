<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vioo-Code | Profile</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="/" class="logo">Vioo-Code</a>
            <ul>
                <li class="when-signed-out"><a href="/sign-in.html">Sign In</a></li>
                <li class="when-signed-out"><a href="/sign-up.html" class="btn">Sign Up</a></li>
                <li class="when-signed-in"><a href="/new-paste.html" class="btn">New Paste</a></li>
                <li class="when-signed-in">
                    <a href="#" id="user-profile-link">
                        <img src="" alt="User Avatar" class="user-avatar" id="user-avatar-nav">
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    <main class="main-content">
        <div class="container">
            <div id="profile-container">Loading profile...</div>
            <div id="profile-actions" style="margin-bottom: 2rem;"></div>
            <h2>Public Pastes</h2>
            <div id="paste-list"></div>
        </div>
    </main>

    <script type="module">
        import { setupUI, getCurrentUser, signOut } from '/config/auth.js';
        import { getProfileByUsername, getPastesByAuthor, deletePaste } from '/config/api.js';

        const profileContainer = document.getElementById('profile-container');
        const profileActionsContainer = document.getElementById('profile-actions');
        const pasteListContainer = document.getElementById('paste-list');

        const params = new URLSearchParams(window.location.search);
        const username = params.get('user');

        const renderPaste = (paste, isOwner) => {
            const pasteEl = document.createElement('div');
            pasteEl.className = 'paste-list-item';
            let ownerControls = '';
            if (isOwner) {
                ownerControls = `<button class="btn btn-danger btn-sm delete-btn" data-id="${paste.id}" data-path="${paste.storage_path}">Delete</button>`;
            }

            pasteEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h3><a href="/view-paste.html?id=${paste.id}">${paste.title}</a></h3>
                        <div class="meta">
                            <span>Language: ${paste.language}</span>
                            <span>Visibility: ${paste.visibility}</span>
                            <span>${new Date(paste.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="owner-controls">
                        ${ownerControls}
                    </div>
                </div>
            `;
            pasteListContainer.appendChild(pasteEl);
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const currentUser = await getCurrentUser();
            setupUI(currentUser);

            if (!username) {
                profileContainer.innerHTML = `<p class="error-message">No username provided.</p>`;
                return;
            }

            const { data: profile, error } = await getProfileByUsername(username);

            if (error || !profile) {
                profileContainer.innerHTML = `<p class="error-message">Profile not found.</p>`;
                return;
            }
            
            document.title = `Vioo-Code | ${profile.username}`;
            profileContainer.innerHTML = `
                <div class="profile-header">
                    <img src="${profile.avatar_url}" alt="${profile.username}">
                    <div class="profile-info">
                        <h1>${profile.username}</h1>
                        <p>${profile.about}</p>
                        <small>Member since ${new Date(profile.created_at).toLocaleDateString()}</small>
                    </div>
                </div>
            `;

            const isOwner = currentUser && currentUser.id === profile.id;

            if (isOwner) {
                const logoutBtn = document.createElement('button');
                logoutBtn.textContent = 'Logout';
                logoutBtn.className = 'btn btn-danger';
                logoutBtn.addEventListener('click', signOut);
                profileActionsContainer.appendChild(logoutBtn);
            }

            const { data: pastes, error: pastesError } = await getPastesByAuthor(profile.id);
            if (pastesError) {
                pasteListContainer.innerHTML = `<p class="error-message">Could not fetch pastes.</p>`;
            } else if (pastes.length === 0) {
                 pasteListContainer.innerHTML = `<p>This user has no public pastes yet.</p>`;
            } else {
                pastes.forEach(p => renderPaste(p, isOwner));
            }
        });

        pasteListContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const pasteId = e.target.dataset.id;
                const storagePath = e.target.dataset.path;
                if (confirm('Are you sure you want to delete this paste? This action cannot be undone.')) {
                    const { error } = await deletePaste(pasteId, storagePath);
                    if (error) {
                        alert('Failed to delete paste: ' + error.message);
                    } else {
                        e.target.closest('.paste-list-item').remove();
                    }
                }
            }
        });
    </script>
</body>
</html>