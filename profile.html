<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="logo">Vioo<span>-Code</span></a>
            <nav>
                <ul>
                    <li class="when-signed-in">
                        <a id="nav-dashboard-link" href="/profile.html">My Dashboard</a>
                    </li>
                    <li class="when-signed-in">
                        <a id="logout-button" href="#">Sign Out</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container" id="profile-page">
    </main>

    <a href="/new-paste.html" id="fab-create-paste" class="fab when-signed-in">+</a>

    <script type="module">
        import { handleSignOut, getCurrentUser } from './config/auth.js';
        import { getUserProfileByUsername, getUserPublicPastes, getUserAllPastes, deletePaste } from './config/api.js';

        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                handleSignOut();
            });
        }
        
        const profilePage = document.getElementById('profile-page');

        const escapeHTML = (str) => str.replace(/[&<>"']/g, match => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[match]);

        const renderPublicProfile = (userData, pastes) => {
            document.title = `${escapeHTML(userData.username)}'s Profile - Vioo-Code`;
            profilePage.innerHTML = `
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <img src="${userData.avatarUrl}" alt="${escapeHTML(userData.username)}">
                        </div>
                        <div class="profile-info">
                            <h1>${escapeHTML(userData.username)}</h1>
                            <p>${escapeHTML(userData.about)}</p>
                        </div>
                    </div>
                    <h2 class="page-title" style="font-size: 1.8rem; margin-top: 3rem;">Public Pastes</h2>
                    <div id="paste-grid" class="paste-grid"></div>
                    <div id="empty-state" class="empty-state" style="display: none;">
                        <h2>This user has no public pastes yet.</h2>
                    </div>
                </div>
            `;
            renderPasteGrid(pastes, 'paste-grid', 'empty-state');
        };
        
        const renderDashboard = (userData, pastes) => {
            document.title = 'My Dashboard - Vioo-Code';
            profilePage.innerHTML = `
                <div class="dashboard-header">
                    <h1 class="page-title">My Dashboard</h1>
                </div>
                <div class="profile-container">
                    <h3>All My Pastes</h3>
                    <table class="dashboard-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Visibility</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-tbody"></tbody>
                    </table>
                     <div id="empty-dashboard" class="empty-state" style="display: none;">
                        <h2>You haven't created any pastes yet.</h2>
                        <p>Click the plus button to create your first paste!</p>
                    </div>
                </div>
            `;
            renderDashboardTable(pastes, userData.uid);
        };
        
        const renderPasteGrid = (pastes, gridId, emptyId) => {
            const grid = document.getElementById(gridId);
            const empty = document.getElementById(emptyId);
            if (!grid) return;

            if (pastes.length === 0) {
                grid.style.display = 'none';
                if(empty) empty.style.display = 'block';
                return;
            }
            grid.innerHTML = pastes.map(paste => `
                <a href="/view-paste.html?id=${paste.pasteId}" class="paste-card">
                    <div class="paste-card-header">
                        <h3>${escapeHTML(paste.title)}</h3>
                    </div>
                    <div class="paste-card-footer">
                        <span class="language-badge">${escapeHTML(paste.language)}</span>
                        <span>${new Date(paste.createdAt).toLocaleDateString()}</span>
                    </div>
                </a>
            `).join('');
        };
        
        const renderDashboardTable = (pastes, currentUid) => {
            const tbody = document.getElementById('dashboard-tbody');
            const empty = document.getElementById('empty-dashboard');
             if (pastes.length === 0) {
                tbody.parentElement.style.display = 'none';
                if(empty) empty.style.display = 'block';
                return;
            }
            tbody.innerHTML = pastes.map(paste => `
                <tr>
                    <td><a href="/view-paste.html?id=${paste.pasteId}">${escapeHTML(paste.title)}</a></td>
                    <td><span class="visibility-badge visibility-${paste.visibility}">${paste.visibility}</span></td>
                    <td>${new Date(paste.createdAt).toLocaleDateString()}</td>
                    <td class="actions-cell">
                        <a href="/new-paste.html?edit=${paste.pasteId}" class="btn btn-primary">Edit</a>
                        <button class="btn btn-secondary delete-btn" data-paste-id="${paste.pasteId}" data-author-uid="${currentUid}">Delete</button>
                    </td>
                </tr>
            `).join('');

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const pasteId = e.target.dataset.pasteId;
                    const authorUid = e.target.dataset.authorUid;
                    if (confirm('Are you sure you want to delete this paste?')) {
                        try {
                           await deletePaste(pasteId, authorUid);
                           e.target.closest('tr').remove();
                           alert('Paste deleted.');
                        } catch (err) {
                            alert('Error deleting paste: ' + err.message);
                        }
                    }
                });
            });
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const username = params.get('username');
            const currentUser = await getCurrentUser();

            if (!username && currentUser) {
                const userProfile = await getUserProfileByUsername(currentUser.email.split('@')[0]);
                if (userProfile && currentUser.uid === userProfile.uid) {
                    const allPastes = await getUserAllPastes(currentUser.uid);
                    renderDashboard(userProfile, allPastes);
                } else {
                     window.location.href = '/';
                }
            } else if (username) {
                const userProfile = await getUserProfileByUsername(username);
                if (userProfile) {
                    if (currentUser && currentUser.uid === userProfile.uid) {
                         const allPastes = await getUserAllPastes(currentUser.uid);
                         renderDashboard(userProfile, allPastes);
                    } else {
                        const publicPastes = await getUserPublicPastes(userProfile.uid);
                        renderPublicProfile(userProfile, publicPastes);
                    }
                } else {
                    profilePage.innerHTML = '<div class="empty-state"><h2>User not found.</h2></div>';
                }
            } else {
                window.location.href = '/sign-in.html';
            }
        });
    </script>
</body>
</html>