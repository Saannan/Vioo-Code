<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <nav class="navbar">
        <div class="logo"><a href="/index.html">Vioo-Code</a></div>
        <div class="nav-links">
            <a href="/index.html">Explore</a>
            <a href="/profile.html" class="when-signed-in" id="profile-link">
                <span id="user-profile-nav">Profile</span>
            </a>
        </div>
        <div class="auth-links">
            <a href="/sign-in.html" class="when-signed-out">Sign In</a>
            <a href="/sign-up.html" class="when-signed-out btn-like">Sign Up</a>
        </div>
    </nav>

    <main class="container" id="main-content">
        <div id="loader">Loading profile...</div>
    </main>

    <a href="/new-paste.html" class="fab">+</a>

    <script type="module">
        import { getCurrentUser, signOut } from './config/auth.js';
        import { getUserProfileByUsername, getUserProfileByAuthId, getPastesByUsername, getMyPastes, deletePaste } from './config/api.js';

        const mainContent = document.getElementById('main-content');
        const params = new URLSearchParams(window.location.search);
        let username = params.get('user');

        let isOwnProfile = false;

        function renderMyPaste(paste) {
            const pasteItem = document.createElement('div');
            pasteItem.className = 'paste-card my-paste-item';
            
            const visibilityIcon = paste.visibility === 'public' ? 'üåê' : 'üîí';

            pasteItem.innerHTML = `
                <div>
                    <a href="/view-paste.html?id=${paste.id}" class="paste-card-title">${paste.title} <span>${visibilityIcon}</span></a>
                    <div class="paste-card-meta">
                        <span>${paste.language}</span> ‚Ä¢ <span>Created on ${new Date(paste.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
                <div class="my-paste-actions">
                    <button class="delete-btn" data-id="${paste.id}" data-path="${paste.storage_path}">Delete</button>
                </div>
            `;
            return pasteItem;
        }

        function renderPublicPaste(paste) {
             const pasteCard = document.createElement('div');
            pasteCard.className = 'paste-card';
            const formattedDate = new Date(paste.created_at).toLocaleDateString();
            pasteCard.innerHTML = `
                 <div class="paste-card-header">
                    <div>
                        <a href="/view-paste.html?id=${paste.id}" class="paste-card-title">${paste.title}</a>
                        <div class="paste-card-meta">
                           <span>Created on ${formattedDate}</span>
                        </div>
                    </div>
                    <span class="paste-card-lang">${paste.language}</span>
                </div>
            `;
            return pasteCard;
        }
        
        async function loadProfile() {
            try {
                const { data: { user } } = await getCurrentUser();
                let profile;

                if (username) {
                    profile = await getUserProfileByUsername(username);
                    if (user && profile.id === user.id) {
                        isOwnProfile = true;
                    }
                } else if (user) {
                    profile = await getUserProfileByAuthId(user.id);
                    isOwnProfile = true;
                    window.history.replaceState({}, '', `/profile.html?user=${profile.username}`);
                } else {
                    window.location.href = '/sign-in.html';
                    return;
                }

                if (!profile) throw new Error('Profile not found.');

                mainContent.innerHTML = `
                    <header class="profile-header">
                        <img src="${profile.avatar_url}" alt="${profile.username}" class="profile-avatar">
                        <div class="profile-info">
                            <h1>${profile.username}</h1>
                            <p>${profile.about || ''}</p>
                            <p>Member since ${new Date(profile.created_at).toLocaleDateString()}</p>
                            <div id="profile-actions" class="profile-actions"></div>
                        </div>
                    </header>
                    <section id="pastes-section">
                        <h2>Pastes</h2>
                        <div id="dashboard-container"></div>
                        <div class="paste-list" id="paste-list"></div>
                    </section>
                `;

                if (isOwnProfile) {
                    document.getElementById('profile-actions').innerHTML = `<button id="logout-btn" class="btn">Logout</button>`;
                    document.getElementById('logout-btn').addEventListener('click', signOut);

                    document.getElementById('dashboard-container').innerHTML = `
                        <div class="dashboard-tabs">
                           <button class="tab-btn active" data-tab="all-pastes">My Pastes</button>
                        </div>
                        <div id="all-pastes" class="dashboard-content active"></div>
                    `;

                    const myPastes = await getMyPastes(user.id);
                    const myPastesContainer = document.getElementById('all-pastes');
                    myPastesContainer.className = 'paste-list';

                    if (myPastes.length > 0) {
                        myPastes.forEach(p => myPastesContainer.appendChild(renderMyPaste(p)));
                    } else {
                        myPastesContainer.innerHTML = '<p>You haven\'t created any pastes yet.</p>';
                    }

                    myPastesContainer.addEventListener('click', async (e) => {
                        if (e.target.classList.contains('delete-btn')) {
                            const pasteId = e.target.dataset.id;
                            const storagePath = e.target.dataset.path;
                            if(confirm('Are you sure you want to delete this paste? This action cannot be undone.')){
                                try {
                                    await deletePaste(pasteId, storagePath);
                                    e.target.closest('.my-paste-item').remove();
                                } catch (error) {
                                    alert(`Error deleting paste: ${error.message}`);
                                }
                            }
                        }
                    });

                } else {
                    const pastes = await getPastesByUsername(profile.username);
                    const pasteList = document.getElementById('paste-list');
                    if (pastes.length > 0) {
                        pastes.forEach(p => pasteList.appendChild(renderPublicPaste(p)));
                    } else {
                        pasteList.innerHTML = '<p>This user has not created any public pastes.</p>';
                    }
                }

            } catch (error) {
                console.error('Error loading profile:', error);
                mainContent.innerHTML = `<h1>Error</h1><p>${error.message}. <a href="/index.html">Go home</a></p>`;
            }
        }
        
        loadProfile();
    </script>
</body>
</html>