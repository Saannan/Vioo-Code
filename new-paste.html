<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vioo-Code | New Paste</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="/" class="logo">Vioo-Code</a>
            <ul>
                <li class="when-signed-in"><a href="/new-paste.html" class="btn">New Paste</a></li>
                <li class="when-signed-in">
                    <a href="#" id="user-profile-link">
                        <img src="" alt="User Avatar" class="user-avatar" id="user-avatar-nav">
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    <main class="main-content">
        <div class="container">
            <h2>Create a New Paste</h2>
            <form id="new-paste-form">
                <div id="error-message" class="error-message" style="display: none;"></div>
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description (Optional)</label>
                    <input type="text" id="description">
                </div>
                <div class="form-group">
                    <label for="content">Code</label>
                    <textarea id="content" required></textarea>
                </div>
                <div class="form-group">
                    <label for="language">Language</label>
                    <input type="text" id="language" list="languages" value="plaintext" required>
                    <datalist id="languages">
                        <option value="plaintext">
                        <option value="javascript">
                        <option value="html">
                        <option value="css">
                        <option value="python">
                        <option value="java">
                        <option value="csharp">
                        <option value="cpp">
                        <option value="php">
                        <option value="ruby">
                        <option value="go">
                        <option value="sql">
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="visibility">Visibility</label>
                    <select id="visibility">
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                    </select>
                </div>
                <button type="submit" class="btn">Create Paste</button>
            </form>
        </div>
    </main>

    <script type="module">
        import { getCurrentUser, setupUI } from '/config/auth.js';
        import { createPaste } from '/config/api.js';

        const form = document.getElementById('new-paste-form');
        const errorMessage = document.getElementById('error-message');

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = '/sign-in.html';
                return;
            }
            setupUI(user);
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.style.display = 'none';

            const pasteData = {
                title: form.title.value,
                description: form.description.value,
                language: form.language.value,
                visibility: form.visibility.value
            };
            const content = form.content.value;
            
            const { error, pasteId } = await createPaste(pasteData, content);

            if (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.style.display = 'block';
            } else {
                window.location.href = `/view-paste.html?id=${pasteId}`;
            }
        });
    </script>
</body>
</html>