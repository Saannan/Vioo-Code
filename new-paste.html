<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Paste - Vioo-Code</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="https://api.dicebear.com/8.x/initials/svg?seed=VC&backgroundColor=1a1a2e,ffc300" type="image/svg+xml">
</head>
<body>
    <div class="aurora-background"><div class="aurora-shape1"></div><div class="aurora-shape2"></div></div>
    <div class="app-layout">
        <aside class="sidebar">
             <a href="/" class="sidebar-logo">Vioo<span>-Code</span></a>
             <nav><ul class="sidebar-nav">
                <li><a href="/index.html"><span>Home</span></a></li>
                <li><a href="/explore.html"><span>Explore</span></a></li>
                <li class="when-signed-in"><a href="/new-paste.html" class="active"><span>New Paste</span></a></li>
             </ul></nav>
        </aside>
        <div class="main-content">
            <header class="main-header">
                <button class="menu-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
                <div class="user-menu when-signed-in">
                    <button class="user-menu-trigger"><img src="" alt="User Avatar" class="user-avatar-img"></button>
                    <div class="user-menu-dropdown">
                         <div class="user-menu-header"><span class="user-username-text"></span></div>
                         <ul class="user-menu-list">
                            <li><a id="dropdown-profile-link" href="#">My Profile</a></li>
                            <li><button id="logout-btn" class="logout-btn">Logout</button></li>
                         </ul>
                    </div>
                </div>
            </header>
            <main class="page-content">
                <div class="form-container">
                    <h1 class="page-title" style="font-size: 1.75rem; border: none; margin-bottom: 1.5rem;">Create a New Paste</h1>
                    <form id="new-paste-form">
                        <div class="form-group"><label for="title">Title</label><input type="text" id="title" name="title" required></div>
                        <div class="form-group"><label for="language">Language</label><select id="language" name="language"><option value="plaintext">Plain Text</option><option value="javascript">JavaScript</option><option value="python">Python</option><option value="java">Java</option><option value="csharp">C#</option><option value="php">PHP</option><option value="cpp">C++</option><option value="typescript">TypeScript</option><option value="html">HTML</option><option value="css">CSS</option></select></div>
                        <div class="form-group"><label>Visibility</label><div class="visibility-options"><label><input type="radio" name="visibility" value="public" checked> Public</label><label><input type="radio" name="visibility" value="unlisted"> Unlisted</label><label><input type="radio" name="visibility" value="private"> Private</label></div></div>
                        <div class="form-group"><label for="content">Code / Text Content</label><textarea id="content" name="content" required placeholder="Paste your code here..." style="min-height: 300px;"></textarea></div>
                        <button type="submit" class="btn btn-primary">Create Paste</button>
                        <p id="error-message" class="error-message"></p>
                    </form>
                </div>
            </main>
        </div>
    </div>
    <script type="module">
        import { auth } from './config/firebase-init.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { handleSignOut, getCurrentUser } from './config/auth.js';
        import { createPaste } from './config/api.js';
        onAuthStateChanged(auth, (user) => { if (!user) window.location.replace('/sign-in.html'); });
        const newPasteForm = document.getElementById('new-paste-form');
        const errorMessage = document.getElementById('error-message');
        const submitBtn = newPasteForm.querySelector('button[type="submit"]');
        newPasteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessage.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            try {
                const newPaste = await createPaste({ title: newPasteForm.title.value, language: newPasteForm.language.value, visibility: newPasteForm.visibility.value, content: newPasteForm.content.value });
                window.location.href = `/view-paste.html?id=${newPaste.pasteId}`;
            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Paste';
            }
        });
        document.getElementById('logout-btn')?.addEventListener('click', handleSignOut);
        const userMenuTrigger = document.querySelector('.user-menu-trigger');
        const userMenuDropdown = document.querySelector('.user-menu-dropdown');
        const profileLink = document.getElementById('dropdown-profile-link');
        userMenuTrigger?.addEventListener('click', () => {
            userMenuDropdown.classList.toggle('active');
            const user = getCurrentUser();
            if(user) profileLink.href = `/profile.html?username=${user.username}`;
        });
        const menuToggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        menuToggle?.addEventListener('click', () => sidebar.classList.toggle('active'));
    </script>
</body>
</html>